<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-list/iron-list.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<dom-module id="tessitura-library">
  <template>
    <style>
      :host {
        display: block;
      }
      #file {
        position: absolute;
        left: -999999px;
        visibility: hidden;
      }
    </style>

    <iron-list items="[[titles]]" as="title">
      <template>
        <div>File: [[title.name]]</div>
      </template>
    </iron-list>

    <input type="file" id="file" name="file" accept="application/pdf"/>
    <paper-fab icon="add"
               on-tap="_addFile">
    </paper-fab>
  </template>
  <script>
    class TessituraLibrary {
      get behaviors() {
        return [];
      }

      beforeRegister() {
        this.is = 'tessitura-library';

        this.properties = {
          titles: {
            type: Array,
            value: () => { return []; }
          }
        };

        this.listeners = {
          'file.change': '_fileChanged'
        };
      }

      ready() {

      }

      listTitles() {
        let _this = this;
        let req = window.app.db.allTitles();
        req.then((titles) => { _this.set('titles', titles); })
          .catch((err) => { console.warn(err); });
      }

      _fileChanged(e) {
        var _this = this;
        var file = e.target.files[0];
        if (!file.type.match('application/pdf')) { return; }
        var reader = new FileReader();
        reader.onload = function(loadEvent) {
          var fileArrayBuffer = loadEvent.target.result;
          var uintArray = new Uint8Array(fileArrayBuffer);
          _this._saveFile(file, uintArray);
        };

        reader.readAsArrayBuffer(file);
      }

      _addFile() {
        this.$.file.click();
      }

      _saveFile(file, fileData) {
        let promise = window.app.db.save('file', {
          name: file.name,
          importedAt: new Date(),
          data: fileData
        });

        promise
          .then((key) => {
            console.log(`Saved with ${key}`);
          })
          .catch((err) => {
            console.warn(`Unable to save file`);
          });
      }
    }

    Polymer(TessituraLibrary);
  </script>
</dom-module>
