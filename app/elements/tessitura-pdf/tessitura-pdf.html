<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<script src="pdf.combined.js"></script>
<script src="pdf-touch-behavior.js"></script>

<dom-module id="tessitura-pdf">
  <template>
    <style>
      :host {
        display: block;
      }
      #viewer {
        width: 100%;
      }
    </style>
    <!-- <paper&#45;button id="back_btn" -->
    <!--               raised -->
    <!--               disabled="{{_nextPageDisabled(currentPage, pdfLength)}}" -->
    <!--               on&#45;tap="_nextPage"> -->
    <!--   &#38;gt; -->
    <!-- </paper&#45;button> -->
    <canvas id="viewer"></canvas>
  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'tessitura-pdf',

      behaviors: [Tessitura.PDFTouchBehavior],

      properties: {
        currentPage: {
          type: Number,
          value: 1
        },
        scale: {
          type: Number,
          value: 1.5
        },
        pdf: {
          type: Object,
          value: undefined
        },
        pdfLength: {
          type: Number,
          value: 0
        }
      },


      ready: function() {
      },


      loadFile: function(file) {
        var _this = this;
        PDFJS.getDocument(file)
          .then(function(pdf) {
            _this.pdf = pdf;
            _this.set('pdfLength', pdf.pdfInfo.numPages);
            _this.setPage(_this.currentPage);
          })
          .catch(function(err) {
            console.warn('[tessitura-pdf] ', err);
          });
      },

      setPage: function(page) {
        var _this = this;
        this.pdf.getPage(page)
          .then(function(page) {
            var scale = _this.scale;
            var viewport = page.getViewport(scale);

            var canvas = document.getElementById('viewer');
            var context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            var renderContext = {
                canvasContext: context,
                  viewport: viewport
            };
            page.render(renderContext);
          })
          .catch(function(err) {
            console.warn('[tessitura-pdf] ', err);
          });
      },

      _nextPage: function() {
        var nextPage = this.currentPage + 1;
        if (nextPage > this.pdfLength) return;
        this.setPage(nextPage);
        this.set('currentPage', nextPage);
      },

      _previousPage: function() {
        var previous = this.currentPage - 1;
        if (previous < 0) return;
        this.setPage(previous);
        this.set('currentPage', previous);
      },

      _nextPageDisabled: function(currentPage, pdfLength) {
        return (currentPage + 1) > pdfLength;
      }
    });
  })();
  </script>
</dom-module>
