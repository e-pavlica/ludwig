<link rel="import" href="../../bower_components/polymer/polymer.html">

<script>
class TessituraDatabase {
  /**
   * Initial Configuration
   */
  constructor() {
    this.DB_NAME = 'tessitura-app';
    this.DB_VERSION = 2;
    this.FILE_STORE_NAME = 'files';
    this.PREFERENCE_STORE_NAME = 'prefs';
    let _this = this;
    let request = window.indexedDB.open(this.DB_NAME, this.DB_VERSION);

    // Successfully Opened IndexedDB
    request.onsuccess = (e) => {
      _this.db = e.target.result;
    };

    // Failed to Open IndexedDB
    request.onerror = (e) => {
      console.warn(`[TessituraDatabase] Error accessing DB:
          ${e.target.errorCode}`);
    };

    // Set Up the DB
    request.onupgradeneeded = (e) => {
      let fileObjectStore = e.target.result.createObjectStore(
          this.FILE_STORE_NAME,
          { autoIncrement: true });
      fileObjectStore.createIndex('title', 'title', { unique: false });

      // Preferences stored as:
      // { pref: 'preference-name', settings: {} }
      let prefObjectStore = e.target.result.createObjectStore(
          this.PREFERENCE_STORE_NAME,
          { keyPath: 'pref' });
    };
  }


  /**
   * Get all Tessitura file entries from IndexedDB
   * @returns {Promise} resolves with Array of files
   */
  getAllFiles() {
    return new Promise((resolve, reject) => {
      var files = [];
      var cursor = this._objectStore(this.FILE_STORE_NAME).openCursor();

      cursor.onsuccess = (e) => {
        let file = e.target.result;
        if (file) {
          files.push(file.value);
          file.continue();
        } else {
          resolve(files);
        }
      };

      cursor.onerror = (e) => {
        console.warn(`[TessituraDatabase] Failed to get files:
            ${e.target.errorCode}`);
        reject(e.target.errorCode);
      };
    });
  }

  /**
   * Get specific file from IndexedDB
   */
  file(fileSelector) {
  }

  /**
   * Save a File to IndexedDB
   * @param {Object} file - Object representing a music file
   * @returns {Promise} resolves with new item ID.
   */
  saveFile(file) {
    let _this = this;
    return new Promise(function(resolve, reject) {
      let request = _this._objectStore(_this.FILE_STORE_NAME, 'readwrite').add(file);
      request.onsuccess = (e) => {
        resolve(e.target.result);
      };

      request.onerror = (e) => {
        console.log(`TessituraDatabase.saveFile failed: ${e}`);
        reject(e);
      };
    });
  }

  /**
   * @param {String} storeName - name of IndexedDB ObjectStore
   * @param {String} mode - IndexedDB access mode. Valid: 'readonly' (default), 'readwrite', or 'versionchange'
   * @returns {IDBObjectStore} - object store
   */
  _objectStore(storeName, mode = 'readonly') {
    return this.db.transaction(storeName, mode).objectStore(storeName);
  }

}
</script>
